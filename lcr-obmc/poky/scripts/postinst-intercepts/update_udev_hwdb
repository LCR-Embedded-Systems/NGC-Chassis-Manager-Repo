#!/bin/sh
#
# SPDX-License-Identifier: MIT
#

# Skip if udevadm doesn't exist or no hwdb sources (common in minimal images)
if [ ! -x "$D${UDEVADM}" ] || [ -z "$(ls -A $D${UDEVLIBDIR}/udev/hwdb.d 2>/dev/null)" ] && [ -z "$(ls -A $D/etc/udev/hwdb.d 2>/dev/null)" ]; then
    echo "Skipping udev hwdb update: binary or sources missing"
    exit 0
fi

case "${PREFERRED_PROVIDER_udev}" in
	systemd)
		UDEV_EXTRA_ARGS="--usr"
		UDEVLIBDIR="${rootlibexecdir}"
		UDEVADM="${base_bindir}/udevadm"
		;;

	*)
		UDEV_EXTRA_ARGS=""
		UDEVLIBDIR="${sysconfdir}"
		UDEVADM="${bindir}/udevadm"
		;;
esac

rm -f $D${UDEVLIBDIR}/udev/hwdb.bin
PSEUDO_UNLOAD=1 ${binprefix}qemuwrapper -L $D $D${UDEVADM} hwdb --update --root $D ${UDEV_EXTRA_ARGS} ||
	PSEUDO_UNLOAD=1 qemuwrapper -L $D $D${UDEVADM} hwdb --update --root $D ${UDEV_EXTRA_ARGS}
chown root:root $D${UDEVLIBDIR}/udev/hwdb.bin
